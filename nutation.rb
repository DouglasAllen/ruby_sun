
def mam(j)
  a = [134.962981389, 477_198.867398056, 0.008697222222, 1.777778e-05]
  horner(j * 10, a) % 360
end

def aolm(j)
  a = [93.271910277, 483_202.017538055, -0.0036825, -3.0555550e-06]
  horner(j * 10, a) % 360
end

def meom(j)
  a = [297.850363055, 445_267.1114, -0.0019141667, 5.2777778e-06]
  horner(j * 10, a) % 360
end

def nutation(j)
  # Given the julian century time
  #  calculates
  #  Delta Epsilon and Delta Psi in degrees

  mam = mam(j)
  mas = ma(j)
  alm = aolm(j)
  em = meom(j)
  om = om(j)
  abcd = NUTATION_COEFFICIENTS
  nutation_long = 0.0
  nutation_oblique = 0.0
  abcd.each_with_index do |e, i|
    sigmaxy = 0.0
    sigmaxy += mam * FAM[i][0] +
               mas * FAM[i][1] +
               alm * FAM[i][2] +
               em * FAM[i][3] +
               om * FAM[i][4]
    nutation_long += ((e[0] +
    (e[1] * j * 10)) * Math.sin(Math::PI / 180 * sigmaxy))
    nutation_oblique += ((e[2] +
    (e[3] * j * 10)) * Math.cos(Math::PI / 180 * sigmaxy))
  end
  [nutation_long / 36_000_000 * Math::PI / 180,
   nutation_oblique / 36_000_000 * Math::PI / 180]

end

# 105
FAM = [
  [+0, +0, +0, +0, +1],
  [+0, +0, +2, -2, +2],
  [+0, +0, +2, +0, +2],
  [+0, +0, +0, +0, +2],
  [+0, -1, +0, +0, +0],
  [+1, +0, +0, +0, +0],
  [+0, +1, +2, -2, +2],
  [+0, +0, +2, +0, +1],
  [+1, +0, +2, +0, +2],
  [+0, -1, +2, -2, +2],

  [-1, +0, +0, +2, +0],
  [+0, +0, +2, -2, +1],
  [-1, +0, +2, +0, +2],
  [+1, +0, +0, +0, +1],
  [+0, +0, +0, +2, +0],
  [-1, +0, +2, +2, +2],
  [-1, +0, +0, +0, +1],
  [+1, +0, +2, +0, +1],
  [-2, +0, +0, +2, +0],
  [-2, +0, +2, +0, +1],

  [+0, +0, +2, +2, +2],
  [+2, +0, +2, +0, +2],
  [+2, +0, +0, +0, +0],
  [+1, +0, +2, -2, +2],
  [+0, +0, +2, +0, +0],
  [+0, +0, +2, -2, +0],
  [-1, +0, +2, +0, +1],
  [+0, +2, +0, +0, +0],
  [+0, +2, +2, -2, +2],
  [-1, +0, +0, +2, +1],

  [+0, +1, +0, +0, +1],
  [+1, +0, +0, -2, +1],
  [+0, -1, +0, +0, +1],
  [+2, +0, -2, +0, +0],
  [-1, +0, +2, +2, +1],
  [+1, +0, +2, +2, +2],
  [+0, -1, +2, +0, +2],
  [+0, +0, +2, +2, +1],
  [+1, +1, +0, -2, +0],
  [+0, +1, +2, +0, +2],

  [-2, +0, +0, +2, +1],
  [+0, +0, +0, +2, +1],
  [+2, +0, +2, -2, +2],
  [+1, +0, +0, +2, +0],
  [+1, +0, +2, -2, +1],
  [+0, +0, +0, -2, +1],
  [+0, -1, +2, -2, +1],
  [+2, +0, +2, +0, +1],
  [+1, -1, +0, +0, +0],
  [+1, +0, +0, -1, +0],

  [+0, +0, +0, +1, +0],
  [+0, +1, +0, -2, +0],
  [+1, +0, -2, +0, +0],
  [+2, +0, +0, -2, +1],
  [+0, +1, +2, -2, +1],
  [+1, +1, +0, +0, +0],
  [+1, -1, +0, -1, +0],
  [-1, -1, +2, +2, +2],
  [+0, -1, +2, +2, +2],
  [+1, -1, +2, +0, +2],

  [+3, +0, +2, +0, +2],
  [+1, +0, +2, +0, +0],
  [-1, +0, +2, +4, +2],
  [+1, +0, +0, +0, +2],
  [-1, +0, +2, -2, +1],
  [+0, -2, +2, -2, +1],
  [-2, +0, +0, +0, +1],
  [+2, +0, +0, +0, +1],
  [+3, +0, +0, +0, +0],
  [+1, +1, +2, +0, +2],

  [+0, +0, +2, +1, +2],
  [+1, +0, +0, +2, +1],
  [+1, +0, +2, +2, +1],
  [+1, +1, +0, -2, +1],
  [+0, +1, +0, +2, +0],
  [+0, +1, +2, -2, +0],
  [+0, +1, -2, +2, +0],
  [+1, +0, -2, +2, +0],
  [+1, +0, -2, -2, +0],
  [+1, +0, +2, -2, +0],

  [+1, +0, +0, -4, +0],
  [+2, +0, +0, -4, +0],
  [+0, +0, +2, +4, +2],
  [+0, +0, +2, -1, +2],
  [-2, +0, +2, +4, +2],
  [+2, +0, +2, +2, +2],
  [+0, -1, +2, +0, +1],
  [+0, +0, -2, +0, +1],
  [+0, +0, +4, -2, +2],
  [+0, +1, +0, +0, +2],

  [+1, +1, +2, -2, +2],
  [+3, +0, +2, -2, +2],
  [-2, +0, +2, +2, +2],
  [-1, +0, +0, +0, +2],
  [+0, +0, -2, +2, +1],
  [+0, +1, +2, +0, +1],
  [-1, +0, +4, +0, +2],
  [+2, +1, +0, -2, +0],
  [+2, +0, +0, +2, +0],
  [+2, +0, +2, -2, +1],

  [+2, +0, -2, +0, +1],
  [+1, -1, +0, -2, +0],
  [-1, +0, +0, +1, +1],
  [-1, -1, +0, +2, +1],
  [+0, +1, +0, +1, +0]
].freeze

NUTATION_COEFFICIENTS = [
  [-171_996.0, -174.2, 92_025.0, 8.90],
  [-13_187.00, -1.600, 5736.000, -3.1],
  [-2274.0000, -0.200, 977.0000, -0.5],
  [2062.00000, 0.2000, -895.000, 0.50],
  [-1426.0000, 3.4000, 54.00000, -0.1],
  [712.000000, 0.1000, -7.00000, 0.00],
  [-517.00000, 1.2000, 224.0000, -0.6],
  [-386.00000, -0.400, 200.0000, 0.00],
  [-301.00000, 0.0000, 129.0000, -0.1],
  [217.000000, -0.500, -95.0000, 0.30],

  [158.000000, 0.0000, -1.00000, 0.00],
  [129.000000, 0.1000, -70.0000, 0.00],
  [123.000000, 0.0000, -53.0000, 0.00],
  [63.0000000, 0.1000, -33.0000, 0.00],
  [63.0000000, 0.0000, -2.00000, 0.00],
  [-59.000000, 0.0000, 26.00000, 0.00],
  [-58.000000, -0.100, 32.00000, 0.00],
  [-51.000000, 0.0000, 27.00000, 0.00],
  [-48.000000, 0.0000, 1.000000, 0.00],
  [46.0000000, 0.0000, -24.0000, 0.00],

  [-38.000000, 0.0000, 16.00000, 0.00],
  [-31.000000, 0.0000, 13.00000, 0.00],
  [29.0000000, 0.0000, -1.00000, 0.00],
  [29.0000000, 0.0000, -12.0000, 0.00],
  [26.0000000, 0.0000, -1.00000, 0.00],
  [-22.000000, 0.0000, 0.000000, 0.00],
  [21.0000000, -0.100, 0.000000, 0.00],
  [-16.000000, 0.1000, 7.000000, 0.00],
  [16.0000000, 0.0000, -8.00000, 0.00],
  [-15.000000, 0.0000, 9.000000, 0.00],

  [-13.000000, 0.0000, 7.000000, 0.00],
  [-12.000000, 0.0000, 6.000000, 0.00],
  [11.0000000, 0.0000, 0.000000, 0.00],
  [-10.000000, 0.0000, 5.000000, 0.00],
  [-8.0000000, 0.0000, 3.000000, 0.00],
  [-7.0000000, 0.0000, 3.000000, 0.00],
  [-7.0000000, 0.0000, 3.000000, 0.00],
  [-7.0000000, 0.0000, 0.000000, 0.00],
  [7.00000000, 0.0000, -3.00000, 0.00],
  [-6.0000000, 0.0000, 3.000000, 0.00],

  [-6.0000000, 0.0000, 3.000000, 0.00],
  [6.00000000, 0.0000, -3.00000, 0.00],
  [6.00000000, 0.0000, 0.000000, 0.00],
  [6.00000000, 0.0000, -3.00000, 0.00],
  [-5.0000000, 0.0000, 3.000000, 0.00],
  [-5.0000000, 0.0000, 3.000000, 0.00],
  [-5.0000000, 0.0000, 3.000000, 0.00],
  [5.00000000, 0.0000, 0.000000, 0.00],
  [-4.0000000, 0.0000, 0.000000, 0.00],
  [-4.0000000, 0.0000, 0.000000, 0.00],

  [-4.0000000, 0.0000, 0.000000, 0.00],
  [4.00000000, 0.0000, 0.000000, 0.00],
  [4.00000000, 0.0000, -2.00000, 0.00],
  [4.00000000, 0.0000, -2.00000, 0.00],
  [-3.0000000, 0.0000, 0.000000, 0.00],
  [-3.0000000, 0.0000, 0.000000, 0.00],
  [-3.0000000, 0.0000, 1.000000, 0.00],
  [-3.0000000, 0.0000, 1.000000, 0.00],
  [-3.0000000, 0.0000, 1.000000, 0.00],
  [-3.0000000, 0.0000, 1.000000, 0.00],

  [3.00000000, 0.0000, 0.000000, 0.00],
  [-2.0000000, 0.0000, 1.000000, 0.00],
  [-2.0000000, 0.0000, 1.000000, 0.00],
  [-2.0000000, 0.0000, 1.000000, 0.00],
  [-2.0000000, 0.0000, 1.000000, 0.00],
  [-2.0000000, 0.0000, 1.000000, 0.00],
  [2.00000000, 0.0000, -1.00000, 0.00],
  [2.00000000, 0.0000, 0.000000, 0.00],
  [2.00000000, 0.0000, -1.00000, 0.00],
  [2.00000000, 0.0000, -1.00000, 0.00],

  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 1.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],

  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 1.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [-1.0000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, -1.00000, 0.00],

  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, -1.00000, 0.00],
  [1.00000000, 0.0000, -1.00000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, -1.00000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00],

  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00],
  [1.00000000, 0.0000, 0.000000, 0.00]
].freeze
